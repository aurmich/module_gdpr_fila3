<?php

declare(strict_types=1);

namespace Modules\Predict\Listeners;

use Carbon\Carbon;
use Illuminate\Auth\Events\Login;
use Modules\Activity\Models\Activity;
use Spatie\Activitylog\Facades\LogBatch;
use Spatie\Activitylog\Contracts\Activity as ActivityContract;

class CheckLoginListener
{
    /**
     * Create the event listener.
     *
     * @return void
     */
    public function __construct()
    {
    }

    /**
     * Handle the event.
     */
    public function handle(Login $event): void
    {
        $user = $event->user;

        $now = Carbon::now();

        activity()
            ->log('login to the site')
            ->withProperties(['consecutive_days' => 'value'])


            // ->tap(function(ActivityContract $activity) {

            //     $last_activity = Activity::where('causer_id', $user->id)
            //         ->where('causer_type', 'user')
            //         ->latest('created_at')
            //         ->select('created_at')
            //         ->first();


            //     if ($this->areDatesConsecutive($last_activity->created_at, $now)) {
            //         // dddx("Le date sono consecutive.");
            //         $activity->consecutive_days = 'my special value';
            //     } else {
            //         // dddx("Le date non sono consecutive.");
            //         $activity->consecutive_days = '0';
            //     }
            //  })

            // ->createdAt($now)
            ;

        // dddx('done');

        // dddx(
        //     Activity::where('causer_id', $user->id)
        //     ->where('causer_type', 'user')
        //     ->latest('created_at')
        //     ->take(2)
        //     ->select('id', 'created_at')
        //     ->get()
        
        // );


        // in una prima settimana, per avere crediti, devo loggarmi ogni giorno e fare almeno una scommessa in quella prima settimana
        // nella settimana successiva, devo sempre loggarmi ogni giorno e fare almeno un altra scommessa in quella settimana, per avere altri crediti

//         [18:03, 27/08/2024] Gianmarco Quaeris: Nel momento in cui ti logghi e fai una scommessa per 7 giorni o più consecutivi ottieni dei crediti bonus giornalieri
// [18:04, 27/08/2024] Gianmarco Quaeris: Se ti logghi e scommetti anche per 20 giorni consecutivi continuerai ad avere 250 o 300 crediti al giorno
// [18:04, 27/08/2024] Gianmarco Quaeris: Se al 21esimo giorno non ti logghi, si resetta il counter dei giorni di accesso e dal 22esimo giorno è come se ricominciassi da 1
    }


    public function areDatesConsecutive($date1, $date2): bool
    {
        // Converti le stringhe delle date in istanze di Carbon
        $carbonDate1 = Carbon::parse($date1);
        $carbonDate2 = Carbon::parse($date2);

        // Controlla se le date sono consecutive
        return $carbonDate1->diffInDays($carbonDate2) === 1 && $carbonDate1->lt($carbonDate2);
    }
}
